name: CI-UnitTests-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main

schedules:
- cron: "0 6 * * 1"    # 06:00 UTC â‰ˆ 08:00 Europe/Paris (CET/CEST)
  displayName: Weekly Monday 08:00 Paris
  branches:
    include:
      - main
  always: true

pool:
  name: 'Private Docker'
  demands:
    - docker

variables:
  buildConfiguration: 'Release'
  NUGET_PACKAGES: '$(Pipeline.Workspace)/.nuget/packages'
  TEST_RESULTS: '$(Pipeline.Workspace)/test-results'

stages:
- stage: UnitTests
  displayName: Unit Tests
  jobs:
  - job: unit
    displayName: Run .NET Unit Tests
    steps:
      - checkout: self
        clean: true

      - template: ../templates/dotnet-setup.yml

      - task: Cache@2
        inputs:
          key: 'nuget | "$(Agent.OS)" | **/packages.lock.json'
          restoreKeys: |
            nuget | "$(Agent.OS)"
            nuget
          path: $(NUGET_PACKAGES)

      - script: dotnet --info
        displayName: 'dotnet --info'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - script: dotnet tool restore
        displayName: 'Tool restore'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - template: ../templates/get-access-token.yml
        parameters:
          tokenServerUrl: $(MONEYERP_ENDPOINT)
          selfSignedServerCert: $(MONEYERP_ENDPOINT_CERTIFICATE)
          clientId: $(MONEYERP_CLIENT_ID)
          clientSecret: $(MONEYERP_CLIENT_SECRET)
          stepName: get_token

      - template: ../templates/fetch-graphql-schema.yml
        parameters:
          tokenServerUrl: $(MONEYERP_ENDPOINT)
          selfSignedServerCert: $(MONEYERP_ENDPOINT_CERTIFICATE)
          access_token: $(get_token.access_token)
          stepName: fetch_schema
          workingDirectory: src/Aviationexam.MoneyErp.Graphql

      - script: dotnet restore --nologo --packages $(NUGET_PACKAGES)
        displayName: 'Restore'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - script: dotnet build --no-restore --nologo --configuration $(buildConfiguration)
        displayName: 'Build'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - script: >
          dotnet test
          --configuration $(buildConfiguration)
          --no-restore --no-build --nologo -- --report-trx --results-directory $(TEST_RESULTS)
          tests
        displayName: 'Test'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - task: PublishTestResults@2
        displayName: 'Publish Test Results'
        inputs:
          testResultsFormat: 'VSTest'
          testResultsFiles: '**/test_results.trx'
          failTaskOnFailedTests: true
          testRunTitle: 'Unit Tests'
