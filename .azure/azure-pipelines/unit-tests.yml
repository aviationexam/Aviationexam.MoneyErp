name: CI-UnitTests-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - fix/*
      - feature/*
      - dependabot/*

pr:
  branches:
    include:
      - features/*
      - fix/*
      - dependabot/*
  drafts: false

schedules:
- cron: "0 6 * * 1"    # 06:00 UTC â‰ˆ 08:00 Europe/Paris (CET/CEST)
  displayName: Weekly Monday 08:00 Paris
  branches:
    include:
      - main
  always: true

pool:
  name: 'Private Docker'
  demands:
    - docker

variables:
  buildConfiguration: 'Release'
  NUGET_PACKAGES: '$(Pipeline.Workspace)/.nuget/packages'
  TEST_RESULTS: '$(Pipeline.Workspace)/test-results'

stages:
- stage: UnitTests
  displayName: Unit Tests
  jobs:
  - job: unit
    displayName: Run .NET Unit Tests
    steps:
      - checkout: self
        clean: true

      - template: ../templates/create-custom-nuget-config.yml
        parameters:
          dotnetPostFix: 'money-erp'
          stepName: 'custom_nuget_config'

      - template: ../templates/dotnet-setup.yml
        parameters:
          dotnetPostFix: 'money-erp'

      - task: Cache@2
        inputs:
          key: 'nuget | "$(Agent.OS)" | **/packages.lock.json'
          restoreKeys: |
            nuget | "$(Agent.OS)"
            nuget
          path: $(NUGET_PACKAGES)

      - script: dotnet --info
        displayName: 'dotnet --info'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - script: dotnet tool restore
        displayName: 'Tool restore'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - template: ../templates/persist-parameter-as-file.yml
        parameters:
          file: $(MONEYERP_ENDPOINT_CERTIFICATE)
          fileExt: 'pem'
          stepName: persist_client_secret

      - template: ../templates/get-access-token.yml
        parameters:
          tokenServerUrl: $(MONEYERP_ENDPOINT)
          selfSignedServerCert: $(persist_client_secret.file_path)
          clientId: $(MONEYERP_CLIENT_ID)
          clientSecret: $(MONEYERP_CLIENT_SECRET)
          stepName: get_token

      - template: ../templates/fetch-graphql-schema.yml
        parameters:
          endpoint: $(MONEYERP_ENDPOINT)
          selfSignedServerCert: $(persist_client_secret.file_path)
          access_token: $(get_token.access_token)
          stepName: fetch_schema
          workingDirectory: src/Aviationexam.MoneyErp.Graphql

      - script: dotnet restore --nologo --packages $(NUGET_PACKAGES)
        displayName: 'Restore'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
          GITHUB_TOKEN: $(GITHUB_TOKEN)

      - script: dotnet build --no-restore --nologo -p:ContinuousIntegrationBuild=true --configuration $(buildConfiguration)
        displayName: 'Build'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - script: >
          dotnet test
          --configuration $(buildConfiguration)
          --no-restore --no-build --report-trx --results-directory $(TEST_RESULTS)
        displayName: 'Test'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
          MONEYERP_ENDPOINT: $(MONEYERP_ENDPOINT)
          MONEYERP_ENDPOINT_CERTIFICATE: $(persist_client_secret.file_path)
          MONEYERP_CLIENT_ID: $(MONEYERP_CLIENT_ID)
          MONEYERP_CLIENT_SECRET: $(MONEYERP_CLIENT_SECRET)

      - task: PublishTestResults@2
        displayName: 'Publish Test Results'
        condition: always()
        inputs:
          testResultsFormat: 'VSTest'
          searchFolder: '$(TEST_RESULTS)'
          testResultsFiles: '*.trx'
          failTaskOnMissingResultsFile: true
          testRunTitle: 'Unit Tests'
          buildConfiguration: '$(buildConfiguration)'
