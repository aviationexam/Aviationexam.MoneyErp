name: Release-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  tags:
    include:
      - '*'

pr: none

pool:
  name: 'Private Docker'
  demands:
    - docker

variables:
  buildConfiguration: 'Release'
  NUGET_PACKAGES: '$(Pipeline.Workspace)/.nuget/packages'

stages:
- stage: UnitTests
  displayName: Unit Tests
  jobs:
  - job: Release
    displayName: Run .NET release
    steps:
      - checkout: self
        clean: true
        fetchDepth: 0

      - template: ../templates/create-custom-nuget-config.yml
        parameters:
          dotnetPostFix: 'money-erp'
          stepName: 'custom_nuget_config'

      - template: ../templates/dotnet-setup.yml
        parameters:
          dotnetPostFix: 'money-erp'

      - task: Cache@2
        inputs:
          key: 'nuget | "$(Agent.OS)" | **/packages.lock.json'
          restoreKeys: |
            nuget | "$(Agent.OS)"
            nuget
          path: $(NUGET_PACKAGES)

      - script: dotnet --info
        displayName: 'dotnet --info'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - task: gitversion-setup@4
        inputs:
          versionSpec: '6.x'

      - task: gitversion-execute@4
        name: gitversion
        inputs:
          configFilePath: 'GitVersion.yml'
          buildNumberFormat: '${GitVersion_FullSemVer}'

      - script: dotnet tool restore
        displayName: 'Tool restore'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - template: ../templates/persist-parameter-as-file.yml
        parameters:
          file: $(MONEYERP_ENDPOINT_CERTIFICATE)
          fileExt: 'pem'
          stepName: persist_client_secret

      - template: ../templates/get-access-token.yml
        parameters:
          tokenServerUrl: $(MONEYERP_ENDPOINT)
          selfSignedServerCert: $(persist_client_secret.file_path)
          clientId: $(MONEYERP_CLIENT_ID)
          clientSecret: $(MONEYERP_CLIENT_SECRET)
          stepName: get_token

      - template: ../templates/fetch-graphql-schema.yml
        parameters:
          endpoint: $(MONEYERP_ENDPOINT)
          selfSignedServerCert: $(persist_client_secret.file_path)
          access_token: $(get_token.access_token)
          stepName: fetch_schema
          workingDirectory: src/Aviationexam.MoneyErp.Graphql

      - task: PublishPipelineArtifact@1
        displayName: 'Publish schema.json'
        inputs:
          targetPath: 'src/Aviationexam.MoneyErp.Graphql/schema.json'
          artifact: 'GraphQL-JSON'
          publishLocation: 'pipeline'

      - task: PublishPipelineArtifact@1
        displayName: 'Publish schema.graphql'
        inputs:
          targetPath: 'src/Aviationexam.MoneyErp.Graphql/schema.graphql'
          artifact: 'GraphQL'
          publishLocation: 'pipeline'

      - script: |
          gh release upload "$(Build.SourceBranchName)" "src/Aviationexam.MoneyErp.Graphql/schema.json"
          gh release upload "$(Build.SourceBranchName)" "src/Aviationexam.MoneyErp.Graphql/schema.graphql"
        displayName: Attach GraphQL resources to the release
        env:
          GITHUB_TOKEN: $(GITHUB_TOKEN)

      - script: dotnet restore --nologo --packages $(NUGET_PACKAGES)
        displayName: 'Restore'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - task: PublishPipelineArtifact@1
        displayName: 'Publish openapi.v1.original.json'
        inputs:
          targetPath: 'src/Aviationexam.MoneyErp.RestApi/openapi.v1.original.json'
          artifact: 'OpenApi-V1'
          publishLocation: 'pipeline'

      - task: PublishPipelineArtifact@1
        displayName: 'Publish openapi.v2.original.json'
        inputs:
          targetPath: 'src/Aviationexam.MoneyErp.RestApi/openapi.v2.original.json'
          artifact: 'OpenApi-V2'
          publishLocation: 'pipeline'

      - script: |
          gh release upload "$(Build.SourceBranchName)" "src/Aviationexam.MoneyErp.RestApi/openapi.v1.original.json"
          gh release upload "$(Build.SourceBranchName)" "src/Aviationexam.MoneyErp.RestApi/openapi.v2.original.json"
        displayName: Attach GraphQL resources to the release
        env:
          GITHUB_TOKEN: $(GITHUB_TOKEN)

      - script: dotnet build --configuration $(buildConfiguration) --no-restore --nologo "-p:Version=$(gitversion.FullSemVer)" -p:ContinuousIntegrationBuild=true
        displayName: 'Build'
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

      - script: |
          dotnet pack src/Aviationexam.MoneyErp.Common/Aviationexam.MoneyErp.Common.csproj --nologo --no-build --configuration $(buildConfiguration) --output nuget-packages -p:PackageVersion=$(gitversion.FullSemVer) -p:ContinuousIntegrationBuild=true
          dotnet pack src/Aviationexam.MoneyErp.RestApi/Aviationexam.MoneyErp.RestApi.csproj --nologo --no-build --configuration $(buildConfiguration) --output nuget-packages -p:PackageVersion=$(gitversion.FullSemVer) -p:ContinuousIntegrationBuild=true
          dotnet pack src/Aviationexam.MoneyErp.Graphql/Aviationexam.MoneyErp.Graphql.csproj --nologo --no-build --configuration $(buildConfiguration) --output nuget-packages -p:PackageVersion=$(gitversion.FullSemVer) -p:ContinuousIntegrationBuild=true -p:NoWarn=NU5104
        displayName: Pack

      - task: PublishPipelineArtifact@1
        displayName: 'Publish nuget packages'
        inputs:
          targetPath: 'nuget-packages'
          artifact: Nuget-packages-$( gitversion.outputs.FullSemVer )
          publishLocation: 'pipeline'

      - script: dotnet nuget push 'nuget-packages/*.nupkg' --api-key $(GITHUB_TOKEN) --source https://nuget.pkg.github.com/aviationexam/index.json
        displayName: Push package to Github Packages

      - script: dotnet nuget push 'nuget-packages/*.nupkg' --api-key $(NUGET_API_KEY) --source https://api.nuget.org/v3/index.json
        displayName: Push package to Nuget
