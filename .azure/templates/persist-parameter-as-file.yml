parameters:
  - name: file
    type: string
  - name: fileExt
    type: string
    default: ''
  - name: stepName
    type: string
  - name: isSecret
    type: boolean
    default: true

steps:
  - bash: |
      set -euo pipefail

      if [[ -n '${{ parameters.file }}' ]]; then
        FILE=$(mktemp "$(Agent.TempDirectory)/param-XXXXXX.${{ parameters.fileExt }}")
        echo "Parameter stored into $FILE"

        echo '${{ parameters.file }}' | base64 -d > "$FILE"

        if [[ '${{ parameters.isSecret }}' -eq 'true' ]]; then
          file_content=$(cat "$FILE")

          escape_data() {
              local data=$1
              data="${data//'%'/'%AZP25'}"
              data="${data//$'\n'/'%0A'}"
              data="${data//$'\r'/'%0D'}"
              echo "$data"
          }

          echo "##vso[task.setvariable variable=${{ parameters.stepName }}_file_content;issecret=true;isOutput=true]$(escape_data $file_content)"

          cat "$FILE"
        fi

        echo "##vso[task.setvariable variable=file_path]$FILE"
        echo "##vso[task.setvariable variable=file_path;isOutput=true]$FILE"
      fi
    name: ${{ parameters.stepName }}
    displayName: 'Persist parameter content as file'
