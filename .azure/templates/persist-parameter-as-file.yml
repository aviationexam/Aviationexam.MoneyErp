parameters:
  - name: file
    type: string
  - name: fileExt
    type: string
    default: ''
  - name: stepName
    type: string
  - name: isSecret
    type: boolean
    default: true

steps:
  - bash: |
      set -euo pipefail

      if [[ -n '${{ parameters.file }}' ]]; then
        FILE=$(mktemp "$(Agent.TempDirectory)/param-XXXXXX.${{ parameters.fileExt }}")
        echo "Parameter stored into $FILE"

        echo '${{ parameters.file }}' | base64 -d > "$FILE"

        echo "##vso[task.setvariable variable=file_path]$FILE"
        echo "##vso[task.setvariable variable=file_path;isOutput=true]$FILE"
      fi
    name: ${{ parameters.stepName }}
    displayName: 'Persist parameter content as file'
  - ${{ if eq(parameters.isSecret, true) }}:
    - bash: |
        set -euo pipefail

        echo '$(file_path)'

        if [[ -f "$(file_path)" ]]; then
          while IFS= read -r line || [[ -n "$line" ]]; do
            [[ -z "$line" ]] && continue

            escape_data() {
                local data="$1"
                data="${data//'%'/'%25'}"
                data="${data//$'\n'/'%0A'}"
                data="${data//$'\r'/'%0D'}"
                data="${data//';'/'%3B'}"
                data="${data//']'/'%5D'}"
                printf '%s' "$data"
            }

            escaped_line="$(escape_data "$line")"

            echo "##vso[task.setvariable variable=mask_line_$RANDOM;issecret=true]$escaped_line"
          done < "$(file_path)"
        fi
        cat "$(file_path)"
      name: ${{ parameters.stepName }}_mask
      displayName: 'Mask file content'
