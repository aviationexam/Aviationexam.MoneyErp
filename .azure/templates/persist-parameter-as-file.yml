parameters:
  - name: file
    type: string
  - name: fileExt
    type: string
    default: ''
  - name: stepName
    type: string
  - name: isSecret
    type: boolean
    default: true

steps:
  - bash: |
      set -euo pipefail

      if [[ -n '${{ parameters.file }}' ]]; then
        FILE=$(mktemp "$(Agent.TempDirectory)/param-XXXXXX.${{ parameters.fileExt }}")
        echo "Parameter stored into $FILE"

        echo '${{ parameters.file }}' | base64 -d > "$FILE"

        if [[ '${{ parameters.isSecret }}' == 'true' ]]; then
          file_content=$(sed \
            -e 's/%/%25/g' \
            -e ':a'  \
            -e 'N'  \
            -e '$!ba' \
            -e 's/\n/%0A/g' \
            "$FILE" | sed 's/\r/%0D/g' \
          )

          echo "##vso[task.setvariable variable=${{ parameters.stepName }}_file_content;issecret=true]${file_content}"
        fi

        echo "##vso[task.setvariable variable=file_path]$FILE"
        echo "##vso[task.setvariable variable=file_path;isOutput=true]$FILE"
      fi
    name: ${{ parameters.stepName }}
    displayName: 'Persist parameter content as file'
